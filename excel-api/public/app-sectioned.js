// Enum values and field metadata will be fetched dynamically from API
let ENUM_VALUES = {};
let FIELD_METADATA = {};

// Hardcoded values for fields that don't have validation in Excel
// G27 values are from —Å–Ω–∞–±–∂–µ–Ω–∏–µ!AM45:AM52 (named range —Ç–∏–ø–æ—Ä–∞–∑–º–µ—Ä—ã_–ö4)
// H27 values are standard heat exchanger pass configurations
const HARDCODED_ENUMS = {
    'tech_G27_sizeTypeK4': [
        '–ö4-750',
        '–ö4-500',
        '–ö4-600',
        '–ö4-600*300',
        '–ö4-1000',
        '–ö4-1000*500',
        '–ö4-1200',
        '–ö4-1200*600'
    ],
    'tech_H27_passes': [
        '1/6',
        '1/1',
        '1/2',
        '1/3',
        '1/4',
        '1/5',
        '2/2',
        '2/3',
        '2/4',
        '2/5',
        '3/3',
        '3/4',
        '4/3',
        '4/4',
        '5/2',
        '6/1'
    ]
};

// Field sections based on Fields2.xlsx structure
const FIELD_SECTIONS = {
    technolog: {
        title: 'üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–ø–ª–æ–æ–±–º–µ–Ω–Ω–∏–∫–∞ (–≤–∫–ª–∞–¥–∫–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥)',
        fields: [
            { id: 'tech_D27_sequenceNumber', label: 'D27 - –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä', type: 'number', default: 1 },
            { id: 'tech_E27_customerOrderPosition', label: 'E27 - –ü–æ–∑–∏—Ü–∏—è –≤ –û–õ –ó–∞–∫–∞–∑—á–∏–∫–∞', type: 'text', default: '–ï-113' },
            { id: 'tech_F27_deliveryType', label: 'F27 - –¢–∏–ø –ø–æ—Å—Ç–∞–≤–∫–∏', type: 'select', enumField: true, default: '–¶–µ–ª—ã–π –¢–ê' },
            { id: 'tech_G27_sizeTypeK4', label: 'G27 - –¢–∏–ø–æ—Ä–∞–∑–º–µ—Ä –ö4', type: 'select', enumField: true, default: '–ö4-750' },
            { id: 'tech_H27_passes', label: 'H27 - –•–æ–¥—ã', type: 'text', placeholder: '10/10', default: '1/6' },
            { id: 'tech_I27_plateQuantity', label: 'I27 - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Å—Ç–∏–Ω, —à—Ç', type: 'number', default: 50 },
            { id: 'tech_J27_calcPressureHotSide', label: 'J27 - –†–∞—Å—á –¥–∞–≤–ª –ø–æ –≥–æ—Ä —Å—Ç–æ—Ä–æ–Ω–µ, –±–∞—Ä', type: 'number', default: 22 },
            { id: 'tech_K27_calcPressureColdSide', label: 'K27 - –†–∞—Å—á –¥–∞–≤–ª –ø–æ —Ö–æ–ª —Å—Ç–æ—Ä–æ–Ω–µ, –±–∞—Ä', type: 'number', default: 23 },
            { id: 'tech_L27_calcTempHotSide', label: 'L27 - –†–∞—Å—á —Ç–µ–º–ø –ø–æ –≥–æ—Ä —Å—Ç–æ—Ä–æ–Ω–µ, ¬∞C', type: 'number', default: 90 },
            { id: 'tech_M27_calcTempColdSide', label: 'M27 - –†–∞—Å—á —Ç–µ–º–ø –ø–æ —Ö–æ–ª —Å—Ç–æ—Ä–æ–Ω–µ, ¬∞C', type: 'number', default: 70 },
            { id: 'tech_P27_plateMaterial', label: 'P27 - –ú–∞—Ç–µ—Ä–∏–∞–ª –ø–ª–∞—Å—Ç–∏–Ω', type: 'select', enumField: true, default: 'AISI 316L' },
            { id: 'tech_Q27_materialType', label: 'Q27 - –ú–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–æ—Ç–æ—á–Ω–æ–π —á–∞—Å—Ç–∏', type: 'text', default: 'AISI 316L' },
            { id: 'tech_R27_bodyMaterial', label: 'R27 - –ú–∞—Ç–µ—Ä–∏–∞–ª –∫–æ—Ä–ø—É—Å–∞', type: 'select', enumField: true, default: '09–ì2–°' },
            { id: 'tech_S27_plateSurfaceType', label: 'S27 - –¢–∏–ø –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –ø–ª–∞—Å—Ç–∏–Ω', type: 'select', enumField: true, default: '–≥–æ—Ñ—Ä–∞' },
            { id: 'tech_T27_drawDepth', label: 'T27 - –ì–ª—É–±–∏–Ω–∞ –≤—ã—Ç—è–∂–∫–∏, –º–º', type: 'number', default: 5 },
            { id: 'tech_U27_plateThickness', label: 'U27 - –¢–æ–ª—â–∏–Ω–∞ –ø–ª–∞—Å—Ç–∏–Ω—ã, –º–º', type: 'select', enumField: true, default: 1 },
            { id: 'tech_V27_claddingThickness', label: 'V27 - –¢–æ–ª—â–∏–Ω–∞ –ø–ª–∞–∫–∏—Ä–æ–≤–∫–∏, –º–º', type: 'select', enumField: true, default: 3 }
        ]
    },
    supply_main: {
        title: 'üí∞ –°–Ω–∞–±–∂–µ–Ω–∏–µ - –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
        fields: [
            { id: 'sup_F2_projectNumber', label: 'F2 - –ù–æ–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–ë24)', type: 'text', default: '' },
            { id: 'sup_D8_flowPartMaterialPricePerKg', label: 'D8 - –¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø—Ä–æ—Ç–æ—á–Ω–æ–π —á–∞—Å—Ç–∏, —Ä—É–±/–∫–≥', type: 'currency', default: 70 },
            { id: 'sup_E8_flowPartMaterialPrice', label: 'E8 - –¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø—Ä–æ—Ç–æ—á–Ω–æ–π —á–∞—Å—Ç–∏', type: 'currency', default: 70 },
            { id: 'sup_D9_bodyMaterial', label: 'D9 - –ú–∞—Ç–µ—Ä–∏–∞–ª –∫–æ—Ä–ø—É—Å–∞', type: 'select', enumField: true, default: '09–ì2–°' },
            { id: 'sup_D10_columnCoverMaterialPrice', label: 'D10 - –¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∫–æ–ª–æ–Ω–Ω/–∫—Ä—ã—à–µ–∫, —Ä—É–±/–∫–≥', type: 'currency', default: 10 },
            { id: 'sup_D11_panelMaterialPrice', label: 'D11 - –¶–µ–Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–∞–Ω–µ–ª–µ–π, —Ä—É–±/–∫–≥', type: 'currency', default: 10 },
            { id: 'sup_K13_normHoursPerUnit', label: 'K13 - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—Ä–º–æ—á–∞—Å–æ–≤', type: 'number', default: 1 },
            { id: 'sup_P13_internalLogistics', label: 'P13 - –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞', type: 'currency', default: 20 },
            { id: 'sup_D17_panelCuttingCoefficient', label: 'D17 - –ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ä–∞—Å–∫—Ä–æ–π –ø–∞–Ω–µ–ª–µ–π', type: 'percentage', default: 1 },
            { id: 'sup_D78_stainlessSteelThickness', label: 'D78 - –¢–æ–ª—â–∏–Ω–∞ –Ω–µ—Ä–∂–∞–≤–µ–π–∫–∏, –º–º', type: 'number', default: 3 }
        ]
    },
    cover_column: {
        title: 'üî© –ö—Ä—ã—à–∫–∞ –∏ –ö–æ–ª–æ–Ω–Ω–∞',
        fields: [
            { id: 'sup_E19_coverRolledThickness', label: 'E19 - –¢–æ–ª—â–∏–Ω–∞ –ø—Ä–æ–∫–∞—Ç–∞ –∫—Ä—ã—à–∫–∏, –º', type: 'number', default: 0.01 },
            { id: 'sup_E20_coverCuttingPrice', label: 'E20 - –¶–µ–Ω–∞ —Ä–∞—Å–∫—Ä–æ—è –∫—Ä—ã—à–∫–∏, —Ä—É–±', type: 'currency', default: 10 },
            { id: 'sup_E21_coverProcessingCost', label: 'E21 - –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—Ä—ã—à–∫–∏, —Ä—É–±', type: 'currency', default: 10 },
            { id: 'sup_K19_columnRolledThickness', label: 'K19 - –¢–æ–ª—â–∏–Ω–∞ –ø—Ä–æ–∫–∞—Ç–∞ –∫–æ–ª–æ–Ω–Ω—ã, –º', type: 'number', default: 0.02 },
            { id: 'sup_K20_columnCuttingPrice', label: 'K20 - –¶–µ–Ω–∞ —Ä–∞—Å–∫—Ä–æ—è –∫–æ–ª–æ–Ω–Ω—ã, —Ä—É–±', type: 'currency', default: 30 },
            { id: 'sup_K21_columnProcessingCost', label: 'K21 - –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–æ–Ω–Ω—ã, —Ä—É–±', type: 'currency', default: 30 }
        ]
    },
    panel_a: {
        title: 'üìê –ü–∞–Ω–µ–ª—å –ê',
        fields: [
            { id: 'sup_E25_panelRolledThickness', label: 'E25 - –¢–æ–ª—â–∏–Ω–∞ –ø—Ä–æ–∫–∞—Ç–∞ –ø–∞–Ω–µ–ª–∏, –º', type: 'number', default: 0.008 },
            { id: 'sup_E26_panelCuttingPrice', label: 'E26 - –¶–µ–Ω–∞ —Ä–∞—Å–∫—Ä–æ—è –ø–∞–Ω–µ–ª–∏, —Ä—É–±', type: 'currency', default: 10 },
            { id: 'sup_E27_panelProcessingCost', label: 'E27 - –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–Ω–µ–ª–∏, —Ä—É–±', type: 'currency', default: 10 },
            { id: 'sup_F28_flange1PanelAPrice', label: 'F28 - –¶–µ–Ω–∞ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ1, —Ä—É–±', type: 'currency', default: 10 },
            { id: 'sup_F29_flange2PanelAPrice', label: 'F29 - –¶–µ–Ω–∞ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ2, —Ä—É–±', type: 'currency', default: 10 },
            { id: 'sup_F30_pipeBilletFlange1Price', label: 'F30 - –¶–µ–Ω–∞ —Ç—Ä—É–±—ã –ø–æ–¥ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'currency', default: 10 },
            { id: 'sup_F31_pipeBilletFlange2Price', label: 'F31 - –¶–µ–Ω–∞ —Ç—Ä—É–±—ã –ø–æ–¥ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'currency', default: 10 },
            { id: 'sup_F32_drainageNozzlePrice', label: 'F32 - –¶–µ–Ω–∞ –ø–∞—Ç—Ä—É–±–∫–∞ –¥—Ä–µ–Ω–∞–∂–∞', type: 'currency', default: 10 },
            { id: 'sup_F33_ventilationNozzlePrice', label: 'F33 - –¶–µ–Ω–∞ –ø–∞—Ç—Ä—É–±–∫–∞ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–∏', type: 'currency', default: 10 },
            { id: 'sup_C28_panelAFlange1Pressure', label: 'C28 - –î–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ1', type: 'select', enumField: true, default: '–†—É10' },
            { id: 'sup_C29_panelAFlange2Pressure', label: 'C29 - –î–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ2', type: 'select', enumField: true, default: '–†—É10' },
            { id: 'sup_D28_panelAFlange1Diameter', label: 'D28 - –î–∏–∞–º–µ—Ç—Ä —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ1', type: 'select', enumField: true, default: '–î—É100' },
            { id: 'sup_D29_panelAFlange2Diameter', label: 'D29 - –î–∏–∞–º–µ—Ç—Ä —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ2', type: 'select', enumField: true, default: '–î—É100' }
        ]
    },
    panel_b: {
        title: 'üìê –ü–∞–Ω–µ–ª—å –ë',
        fields: [
            { id: 'sup_K25_panelBRolledThickness', label: 'K25 - –¢–æ–ª—â–∏–Ω–∞ –ø—Ä–æ–∫–∞—Ç–∞ –ø–∞–Ω–µ–ª–∏ –ë, –º', type: 'number', default: 0.012 },
            { id: 'sup_K26_panelBCuttingPrice', label: 'K26 - –¶–µ–Ω–∞ —Ä–∞—Å–∫—Ä–æ—è –ø–∞–Ω–µ–ª–∏ –ë, —Ä—É–±', type: 'currency', default: 30 },
            { id: 'sup_K27_panelBProcessingCost', label: 'K27 - –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–Ω–µ–ª–∏ –ë, —Ä—É–±', type: 'currency', default: 30 },
            { id: 'sup_L28_panelBFlange3Price', label: 'L28 - –¶–µ–Ω–∞ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ3, —Ä—É–±', type: 'currency', default: 40 },
            { id: 'sup_L29_panelBFlange4Price', label: 'L29 - –¶–µ–Ω–∞ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ4, —Ä—É–±', type: 'currency', default: 40 },
            { id: 'sup_L30_panelBPipeBilletFlange3Price', label: 'L30 - –¶–µ–Ω–∞ —Ç—Ä—É–±—ã –ø–æ–¥ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'currency', default: 40 },
            { id: 'sup_L31_panelBPipeBilletFlange4Price', label: 'L31 - –¶–µ–Ω–∞ —Ç—Ä—É–±—ã –ø–æ–¥ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'currency', default: 40 },
            { id: 'sup_L32_panelBDrainageNozzlePrice', label: 'L32 - –¶–µ–Ω–∞ –ø–∞—Ç—Ä—É–±–∫–∞ –¥—Ä–µ–Ω–∞–∂–∞ –ø–∞–Ω–µ–ª—å –ë', type: 'currency', default: 40 },
            { id: 'sup_L33_panelBVentilationNozzlePrice', label: 'L33 - –¶–µ–Ω–∞ –ø–∞—Ç—Ä—É–±–∫–∞ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–∏ –ø–∞–Ω–µ–ª—å –ë', type: 'currency', default: 40 },
            { id: 'sup_I28_panelBFlange3Pressure', label: 'I28 - –î–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ3', type: 'select', enumField: true, default: '–†—É10' },
            { id: 'sup_I29_panelBFlange4Pressure', label: 'I29 - –î–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ4', type: 'select', enumField: true, default: '–†—É10' },
            { id: 'sup_J28_panelBFlange3Diameter', label: 'J28 - –î–∏–∞–º–µ—Ç—Ä —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ3', type: 'select', enumField: true, default: '–î—É100' },
            { id: 'sup_J29_panelBFlange4Diameter', label: 'J29 - –î–∏–∞–º–µ—Ç—Ä —Ñ–ª–∞–Ω—Ü–∞ ‚Ññ4', type: 'select', enumField: true, default: '–î—É100' }
        ]
    },
    gaskets_studs: {
        title: 'üîß –ü—Ä–æ–∫–ª–∞–¥–∫–∏ –∏ –†–∞—Å–ø–æ—Ä–∫–∏',
        fields: [
            { id: 'sup_F39_spareKitsPressureReserve', label: 'F39 - –ó–∞–ø–∞—Å–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Ç—ã —Ä–µ–∑–µ—Ä–≤', type: 'select', enumField: true, default: '2' },
            { id: 'sup_D38_panelGasketsPrice', label: 'D38 - –¶–µ–Ω–∞ –ø—Ä–æ–∫–ª–∞–¥–∫–∏ –ø–∞–Ω–µ–ª–µ–π', type: 'currency', default: 10 },
            { id: 'sup_D43_studM24x2000Price', label: 'D43 - –¶–µ–Ω–∞ —à–ø–∏–ª—å–∫–∏ –ú24—Ö2000', type: 'currency', default: 33 },
            { id: 'sup_D44_studM24x1000Price', label: 'D44 - –¶–µ–Ω–∞ —à–ø–∏–ª—å–∫–∏ –ú24—Ö1000', type: 'currency', default: 17 },
            { id: 'sup_D45_studM20x2000Price', label: 'D45 - –¶–µ–Ω–∞ —à–ø–∏–ª—å–∫–∏ –ú20—Ö2000', type: 'currency', default: 28 },
            { id: 'sup_D46_studM20M16x1000Price', label: 'D46 - –¶–µ–Ω–∞ —à–ø–∏–ª—å–∫–∏ –ú20/–ú16—Ö1000', type: 'currency', default: 12 },
            { id: 'sup_G43_nutM24DIN6330Price', label: 'G43 - –¶–µ–Ω–∞ –≥–∞–π–∫–∏ –ú24 DIN6330', type: 'currency', default: 20 },
            { id: 'sup_G44_nutM24DIN933Price', label: 'G44 - –¶–µ–Ω–∞ –≥–∞–π–∫–∏ –ú24 DIN933', type: 'currency', default: 20 },
            { id: 'sup_G45_nutM20M16DIN933Price', label: 'G45 - –¶–µ–Ω–∞ –≥–∞–π–∫–∏ –ú20/–ú16 DIN933', type: 'currency', default: 20 }
        ]
    },
    spare_parts: {
        title: 'üîÑ –ó–ò–ü (–ó–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏)',
        fields: [
            { id: 'sup_H54_spareFlangeFlange1Price', label: 'H54 - –ó–ò–ü –∫—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'currency', default: 20 },
            { id: 'sup_H55_spareFlangeFlange2Price', label: 'H55 - –ó–ò–ü –∫—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'currency', default: 20 },
            { id: 'sup_H56_spareFlangeFlange3Price', label: 'H56 - –ó–ò–ü –∫—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'currency', default: 20 },
            { id: 'sup_H57_spareFlangeFlange4Price', label: 'H57 - –ó–ò–ü –∫—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'currency', default: 20 },
            { id: 'sup_I50_sparePanelStudQuantity', label: 'I50 - –ó–ò–ü —à–ø–∏–ª—å–∫–∞ –∫–æ–ª-–≤–æ', type: 'number', default: 10 },
            { id: 'sup_I51_sparePanelNutQuantity', label: 'I51 - –ó–ò–ü –≥–∞–π–∫–∞ –∫–æ–ª-–≤–æ', type: 'number', default: 10 },
            { id: 'sup_I52_sparePanelWasherQuantity', label: 'I52 - –ó–ò–ü —à–∞–π–±–∞ –∫–æ–ª-–≤–æ', type: 'number', default: 10 },
            { id: 'sup_I54_flangeFastenersFlange1Quantity', label: 'I54 - –ö—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1 –∫–æ–ª-–≤–æ', type: 'number', default: 8 },
            { id: 'sup_I55_flangeFastenersFlange2Quantity', label: 'I55 - –ö—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2 –∫–æ–ª-–≤–æ', type: 'number', default: 8 },
            { id: 'sup_I56_flangeFastenersFlange3Quantity', label: 'I56 - –ö—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3 –∫–æ–ª-–≤–æ', type: 'number', default: 8 },
            { id: 'sup_I57_flangeFastenersFlange4Quantity', label: 'I57 - –ö—Ä–µ–ø–µ–∂ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4 –∫–æ–ª-–≤–æ', type: 'number', default: 8 },
            { id: 'sup_M51_spareAnchorBoltsCost', label: 'M51 - –ó–ò–ü –∞–Ω–∫–µ—Ä–Ω—ã–µ –±–æ–ª—Ç—ã —Å—Ç–æ–∏–º–æ—Å—Ç—å', type: 'currency', default: 50 },
            { id: 'sup_M52_spareOtherCost', label: 'M52 - –ó–ò–ü –¥—Ä—É–≥–æ–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å', type: 'currency', default: 50 },
            { id: 'sup_N50_sparePanelGasketsQuantity', label: 'N50 - –ó–ò–ü –ø—Ä–æ–∫–ª–∞–¥–∫–∏ –ø–∞–Ω–µ–ª–µ–π –∫–æ–ª-–≤–æ', type: 'number', default: 5 },
            { id: 'sup_N51_spareAnchorBoltsQuantity', label: 'N51 - –ó–ò–ü –∞–Ω–∫–µ—Ä–Ω—ã–µ –±–æ–ª—Ç—ã –∫–æ–ª-–≤–æ', type: 'number', default: 4 },
            { id: 'sup_N52_spareOtherQuantity', label: 'N52 - –ó–ò–ü –¥—Ä—É–≥–æ–µ –∫–æ–ª-–≤–æ', type: 'number', default: 2 },
            { id: 'sup_N54_spareFlangeGasketsFlange1Quantity', label: 'N54 - –ó–ò–ü –ø—Ä–æ–∫–ª–∞–¥–∫–∏ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'number', default: 2 },
            { id: 'sup_N55_spareFlangeGasketsFlange2Quantity', label: 'N55 - –ó–ò–ü –ø—Ä–æ–∫–ª–∞–¥–∫–∏ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'number', default: 2 },
            { id: 'sup_N56_spareFlangeGasketsFlange3Quantity', label: 'N56 - –ó–ò–ü –ø—Ä–æ–∫–ª–∞–¥–∫–∏ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'number', default: 2 },
            { id: 'sup_N57_spareFlangeGasketsFlange4Quantity', label: 'N57 - –ó–ò–ü –ø—Ä–æ–∫–ª–∞–¥–∫–∏ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'number', default: 2 }
        ]
    },
    supports_braces: {
        title: 'üèóÔ∏è –û–ø–æ—Ä—ã –∏ –†–∞—Å–∫–æ—Å—ã',
        fields: [
            { id: 'sup_I38_eyeboltKitMaterialCost', label: 'I38 - –ü—Ä–æ—É—à–∏–Ω—ã –º–µ—Ç–∞–ª–ª', type: 'currency', default: 20 },
            { id: 'sup_I39_eyeboltKitProcessingCost', label: 'I39 - –ü—Ä–æ—É—à–∏–Ω—ã –æ–±—Ä–∞–±–æ—Ç–∫–∞', type: 'currency', default: 20 },
            { id: 'sup_K38_supportsKitMaterialCost', label: 'K38 - –õ–∞–ø—ã –º–µ—Ç–∞–ª–ª', type: 'currency', default: 30 },
            { id: 'sup_K39_supportsKitProcessingCost', label: 'K39 - –õ–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∞', type: 'currency', default: 30 },
            { id: 'sup_M38_bracesKitMaterialCost', label: 'M38 - –†–∞—Å–∫–æ—Å—ã –º–µ—Ç–∞–ª–ª', type: 'currency', default: 50 },
            { id: 'sup_M39_bracesKitProcessingCost', label: 'M39 - –†–∞—Å–∫–æ—Å—ã –æ–±—Ä–∞–±–æ—Ç–∫–∞', type: 'currency', default: 50 }
        ]
    },
    other_materials: {
        title: 'üì¶ –î—Ä—É–≥–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã',
        fields: [
            { id: 'sup_I44_otherMaterialsDesc1', label: 'I44 - –î—Ä—É–≥–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã 1', type: 'textarea', default: '' },
            { id: 'sup_I45_otherMaterialsDesc2', label: 'I45 - –î—Ä—É–≥–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã 2', type: 'textarea', default: '' },
            { id: 'sup_I46_otherMaterialsDesc3', label: 'I46 - –î—Ä—É–≥–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã 3', type: 'textarea', default: '' },
            { id: 'sup_M44_otherMaterialsCost1', label: 'M44 - –°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ 1', type: 'currency', default: 50 },
            { id: 'sup_M45_otherMaterialsCost2', label: 'M45 - –°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ 2', type: 'currency', default: 50 },
            { id: 'sup_M46_otherMaterialsCost3', label: 'M46 - –°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ 3', type: 'currency', default: 50 }
        ]
    },
    panel_fasteners: {
        title: '‚öôÔ∏è –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π',
        fields: [
            { id: 'sup_P19_panelFastenersQuantity', label: 'P19 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π –∫–æ–ª-–≤–æ', type: 'number', default: 10 },
            { id: 'sup_P20_panelFastenersMaterial', label: 'P20 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π –º–∞—Ç–µ—Ä–∏–∞–ª', type: 'select', enumField: true, default: '09–ì2–°' },
            { id: 'sup_P21_panelFastenersCoating', label: 'P21 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π –ø–æ–∫—Ä—ã—Ç–∏–µ', type: 'select', enumField: true, default: '' },
            { id: 'sup_P22_panelFastenersStudSize', label: 'P22 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π —Ä–∞–∑–º–µ—Ä —à–ø–∏–ª—å–∫–∏', type: 'select', enumField: true, default: '' },
            { id: 'sup_Q22_panelFastenersStudCost', label: 'Q22 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π —Ü–µ–Ω–∞ —à–ø–∏–ª—å–∫–∏', type: 'currency', default: 10 },
            { id: 'sup_Q23_panelFastenersNutCost', label: 'Q23 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π —Ü–µ–Ω–∞ –≥–∞–π–∫–∏', type: 'currency', default: 5 },
            { id: 'sup_Q24_panelFastenersWasherCost', label: 'Q24 - –ö—Ä–µ–ø–µ–∂ –ø–∞–Ω–µ–ª–µ–π —Ü–µ–Ω–∞ —à–∞–π–±—ã', type: 'currency', default: 2 },
            { id: 'sup_P45_unaccountedCost', label: 'P45 - –ù–µ—É—á—Ç–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å', type: 'currency', default: 70 }
        ]
    },
    cof_fasteners: {
        title: 'üîó –ö–û–§ (–ö–æ–º–ø–ª–µ–∫—Ç –û—Ç–≤–µ—Ç–Ω—ã—Ö –§–ª–∞–Ω—Ü–µ–≤)',
        fields: [
            { id: 'sup_P29_cofFastenersFlange1Size', label: 'P29 - –ö–û–§ —Ä–∞–∑–º–µ—Ä –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'select', enumField: true, default: '' },
            { id: 'sup_P33_cofFastenersFlange2Size', label: 'P33 - –ö–û–§ —Ä–∞–∑–º–µ—Ä –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'select', enumField: true, default: '' },
            { id: 'sup_P37_cofFastenersFlange3Size', label: 'P37 - –ö–û–§ —Ä–∞–∑–º–µ—Ä –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'select', enumField: true, default: '' },
            { id: 'sup_P41_cofFastenersFlange4Size', label: 'P41 - –ö–û–§ —Ä–∞–∑–º–µ—Ä –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'select', enumField: true, default: '' },
            { id: 'sup_Q29_cofFastenersFlange1Material', label: 'Q29 - –ö–û–§ –º–∞—Ç–µ—Ä–∏–∞–ª –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'select', enumField: true, default: '' },
            { id: 'sup_Q33_cofFastenersFlange2Material', label: 'Q33 - –ö–û–§ –º–∞—Ç–µ—Ä–∏–∞–ª –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'select', enumField: true, default: '' },
            { id: 'sup_Q37_cofFastenersFlange3Material', label: 'Q37 - –ö–û–§ –º–∞—Ç–µ—Ä–∏–∞–ª –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'select', enumField: true, default: '' },
            { id: 'sup_Q41_cofFastenersFlange4Material', label: 'Q41 - –ö–û–§ –º–∞—Ç–µ—Ä–∏–∞–ª –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'select', enumField: true, default: '' },
            { id: 'sup_R29_cofFastenersFlange1Coating', label: 'R29 - –ö–û–§ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'select', enumField: true, default: '' },
            { id: 'sup_R33_cofFastenersFlange2Coating', label: 'R33 - –ö–û–§ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'select', enumField: true, default: '' },
            { id: 'sup_R37_cofFastenersFlange3Coating', label: 'R37 - –ö–û–§ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'select', enumField: true, default: '' },
            { id: 'sup_R41_cofFastenersFlange4Coating', label: 'R41 - –ö–û–§ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ–ø–µ–∂–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'select', enumField: true, default: '' },
            { id: 'sup_T29_cofFastenersFlange1KitPrice', label: 'T29 - –ö–û–§ —Ü–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'currency', default: 29 },
            { id: 'sup_T30_cofGasketFlange1Price', label: 'T30 - –ö–û–§ –ø—Ä–æ–∫–ª–∞–¥–∫–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'currency', default: 30 },
            { id: 'sup_T31_cofObturatorFlange1Price', label: 'T31 - –ö–û–§ –æ–±—Ç—é—Ä–∞—Ç–æ—Ä —Ñ–ª–∞–Ω–µ—Ü ‚Ññ1', type: 'currency', default: 31 },
            { id: 'sup_T33_cofFastenersFlange2KitPrice', label: 'T33 - –ö–û–§ —Ü–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'currency', default: 33 },
            { id: 'sup_T34_cofGasketFlange2Price', label: 'T34 - –ö–û–§ –ø—Ä–æ–∫–ª–∞–¥–∫–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'currency', default: 34 },
            { id: 'sup_T35_cofObturatorFlange2Price', label: 'T35 - –ö–û–§ –æ–±—Ç—é—Ä–∞—Ç–æ—Ä —Ñ–ª–∞–Ω–µ—Ü ‚Ññ2', type: 'currency', default: 35 },
            { id: 'sup_T37_cofFastenersFlange3KitPrice', label: 'T37 - –ö–û–§ —Ü–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'currency', default: 37 },
            { id: 'sup_T38_cofGasketFlange3Price', label: 'T38 - –ö–û–§ –ø—Ä–æ–∫–ª–∞–¥–∫–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'currency', default: 38 },
            { id: 'sup_T39_cofObturatorFlange3Price', label: 'T39 - –ö–û–§ –æ–±—Ç—é—Ä–∞—Ç–æ—Ä —Ñ–ª–∞–Ω–µ—Ü ‚Ññ3', type: 'currency', default: 39 },
            { id: 'sup_T41_cofFastenersFlange4KitPrice', label: 'T41 - –ö–û–§ —Ü–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'currency', default: 41 },
            { id: 'sup_T42_cofGasketFlange4Price', label: 'T42 - –ö–û–§ –ø—Ä–æ–∫–ª–∞–¥–∫–∞ —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'currency', default: 42 },
            { id: 'sup_T43_cofObturatorFlange4Price', label: 'T43 - –ö–û–§ –æ–±—Ç—é—Ä–∞—Ç–æ—Ä —Ñ–ª–∞–Ω–µ—Ü ‚Ññ4', type: 'currency', default: 43 }
        ]
    }
};

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

// Initialize application
async function initializeApp() {
    console.log('Initializing application with sectioned layout...');
    
    // Fetch field metadata and enum values
    await fetchFieldMetadata();
    
    // Create the sectioned form
    createSectionedForm();
    
    // Load saved values
    loadSavedValues();
    
    // Setup event handlers
    setupEventHandlers();
    
    // Load generated files list
    loadGeneratedFiles();
}

// Fetch field metadata from API with fallback
async function fetchFieldMetadata() {
    try {
        // Try to fetch metadata endpoint
        const metadataResponse = await fetch('/api/fields/metadata');
        if (metadataResponse.ok) {
            const data = await metadataResponse.json();
            console.log('Fetched field metadata:', data);
            
            // Process metadata
            if (data.fields) {
                data.fields.forEach(field => {
                    FIELD_METADATA[field.id] = field;
                    if (field.enumValues) {
                        ENUM_VALUES[field.id] = field.enumValues;
                    }
                });
            }
            return;
        }
    } catch (error) {
        console.log('Metadata endpoint not available, falling back to enum endpoint');
    }
    
    // Fallback to enum endpoint
    try {
        const enumResponse = await fetch('/api/fields/enum');
        if (enumResponse.ok) {
            const data = await enumResponse.json();
            console.log('Fetched enum values:', data);
            if (data.fields) {
                ENUM_VALUES = data.fields;
            }
        }
    } catch (error) {
        console.error('Error fetching field data:', error);
    }
}

// Create sectioned form
function createSectionedForm() {
    const container = document.getElementById('fieldsContainer');
    if (!container) {
        console.error('Fields container not found');
        return;
    }
    
    container.innerHTML = '';
    
    // Create sections
    for (const [sectionKey, section] of Object.entries(FIELD_SECTIONS)) {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section';
        sectionDiv.id = `section-${sectionKey}`;
        
        // Section header
        const header = document.createElement('h3');
        header.className = 'section-header';
        header.innerHTML = `
            <span class="section-toggle">‚ñº</span>
            ${section.title}
            <span class="field-count">(${section.fields.length} –ø–æ–ª–µ–π)</span>
        `;
        header.onclick = () => toggleSection(sectionKey);
        sectionDiv.appendChild(header);
        
        // Section content
        const content = document.createElement('div');
        content.className = 'section-content';
        content.id = `section-content-${sectionKey}`;
        
        // Create fields grid
        const fieldsGrid = document.createElement('div');
        fieldsGrid.className = 'fields-grid';
        
        section.fields.forEach(field => {
            const fieldDiv = renderField(field);
            fieldsGrid.appendChild(fieldDiv);
        });
        
        content.appendChild(fieldsGrid);
        sectionDiv.appendChild(content);
        container.appendChild(sectionDiv);
    }
    
    // Add section navigation
    addSectionNavigation();
}

// Render individual field
function renderField(field) {
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'form-group';
    
    const label = document.createElement('label');
    label.htmlFor = field.id;
    label.textContent = field.label;
    
    // Add currency symbol for currency fields
    if (field.type === 'currency') {
        label.innerHTML = field.label + ' <span class="currency-symbol">‚ÇΩ</span>';
    }
    // Add percentage symbol for percentage fields  
    else if (field.type === 'percentage') {
        label.innerHTML = field.label + ' <span class="percentage-symbol">%</span>';
    }
    
    fieldDiv.appendChild(label);
    
    let input;
    
    // Check if field has enum values (from API or hardcoded)
    const hasEnumValues = field.enumField && (ENUM_VALUES[field.id] || HARDCODED_ENUMS[field.id]);
    
    if (field.type === 'select' || hasEnumValues) {
        input = document.createElement('select');
        input.id = field.id;
        input.name = field.id;
        
        // Add empty option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- –í—ã–±–µ—Ä–∏—Ç–µ --';
        input.appendChild(emptyOption);
        
        // Add enum values if available (from API or hardcoded)
        const enumValues = ENUM_VALUES[field.id] || HARDCODED_ENUMS[field.id];
        if (enumValues) {
            enumValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                input.appendChild(option);
            });
            
            // Select first enum value if available
            if (enumValues.length > 0) {
                input.value = enumValues[0];
            }
        }
        
        // Set default value if specified and not already set
        if (field.default && !input.value) {
            input.value = field.default;
        }
    } else if (field.type === 'textarea') {
        input = document.createElement('textarea');
        input.id = field.id;
        input.name = field.id;
        input.rows = 3;
        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ...';
        input.value = field.default || '';
    } else {
        input = document.createElement('input');
        input.id = field.id;
        input.name = field.id;
        
        // Set input type
        if (field.type === 'number' || field.type === 'currency' || field.type === 'percentage') {
            input.type = 'number';
            input.step = field.type === 'currency' ? '0.01' : 'any';
            
            // Apply validation from metadata
            const metadata = FIELD_METADATA[field.id];
            if (metadata && metadata.validation) {
                if (metadata.validation.min !== undefined) {
                    input.min = metadata.validation.min;
                }
                if (metadata.validation.max !== undefined) {
                    input.max = metadata.validation.max;
                }
            }
        } else {
            input.type = 'text';
        }
        
        input.value = field.default || '';
        
        // Add placeholders
        if (field.type === 'currency') {
            input.placeholder = '0.00';
        } else if (field.type === 'percentage') {
            input.placeholder = '1.0';
        } else if (field.placeholder) {
            input.placeholder = field.placeholder;
        }
    }
    
    // Add field ID as data attribute for easy access
    input.dataset.fieldId = field.id;
    
    fieldDiv.appendChild(input);
    
    return fieldDiv;
}

// Toggle section visibility
function toggleSection(sectionKey) {
    const content = document.getElementById(`section-content-${sectionKey}`);
    const header = document.querySelector(`#section-${sectionKey} .section-toggle`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        header.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        header.textContent = '‚ñ∂';
    }
}

// Add section navigation
function addSectionNavigation() {
    // Create upload section first (prominent at top)
    const uploadSection = document.createElement('div');
    uploadSection.className = 'upload-section';
    uploadSection.innerHTML = `
        <div class="upload-container">
            <h2>üì§ –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã</h2>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ä–∞—Å—á–µ—Ç–∞–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π</p>
            <div class="upload-controls">
                <button id="uploadExcelBtn" class="upload-excel-btn" onclick="showUploadDialog()">
                    <span class="upload-icon">üìÅ</span>
                    <span>–í—ã–±—Ä–∞—Ç—å Excel —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span>
                </button>
                <input type="file" id="excelFileInput" accept=".xlsx" style="display:none" onchange="handleFileSelect(event)">
                <a href="/api/upload-prefill/sample" class="sample-link">üí° –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞</a>
            </div>
            <div id="uploadStatus" class="upload-status" style="display:none"></div>
        </div>
    `;
    
    // Then add regular navigation
    const nav = document.createElement('div');
    nav.className = 'section-navigation';
    nav.innerHTML = `
        <button onclick="expandAllSections()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button onclick="collapseAllSections()">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
    `;
    
    const container = document.getElementById('fieldsContainer');
    container.parentNode.insertBefore(uploadSection, container);
    container.parentNode.insertBefore(nav, container);
}

// Expand all sections
function expandAllSections() {
    Object.keys(FIELD_SECTIONS).forEach(sectionKey => {
        const content = document.getElementById(`section-content-${sectionKey}`);
        const header = document.querySelector(`#section-${sectionKey} .section-toggle`);
        if (content) {
            content.style.display = 'block';
            header.textContent = '‚ñº';
        }
    });
}

// Collapse all sections
function collapseAllSections() {
    Object.keys(FIELD_SECTIONS).forEach(sectionKey => {
        const content = document.getElementById(`section-content-${sectionKey}`);
        const header = document.querySelector(`#section-${sectionKey} .section-toggle`);
        if (content) {
            content.style.display = 'none';
            header.textContent = '‚ñ∂';
        }
    });
}

// Setup event handlers
function setupEventHandlers() {
    // Calculate button
    const calculateBtn = document.getElementById('calculateBtn');
    if (calculateBtn) {
        calculateBtn.addEventListener('click', calculateCost);
    }
    
    // Load defaults button
    const loadDefaultsBtn = document.getElementById('loadDefaultsBtn');
    if (loadDefaultsBtn) {
        loadDefaultsBtn.addEventListener('click', loadDefaults);
    }
    
    // Clear form button
    const clearFormBtn = document.getElementById('clearFormBtn');
    if (clearFormBtn) {
        clearFormBtn.addEventListener('click', clearForm);
    }
}

// Calculate cost
async function calculateCost() {
    const requestData = {};
    const resultsDiv = document.getElementById('results');
    const calculateBtn = document.getElementById('calculateBtn');
    
    // Show loading state
    if (resultsDiv) {
        resultsDiv.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <h3>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç...</h3>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
            </div>
        `;
    }
    
    // Disable button during calculation
    if (calculateBtn) {
        calculateBtn.disabled = true;
        calculateBtn.textContent = '–†–∞—Å—á–µ—Ç...';
    }
    
    // Collect all field values
    Object.values(FIELD_SECTIONS).forEach(section => {
        section.fields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                const value = input.value.trim();
                if (value !== '') {
                    // Convert to appropriate type based on field definition
                    if (field.type === 'number' || field.type === 'currency' || field.type === 'percentage') {
                        // Convert to number for numeric fields
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            requestData[field.id] = numValue;
                        }
                    } else {
                        // Keep as string for text fields
                        requestData[field.id] = value;
                    }
                }
            }
        });
    });
    
    console.log('Sending request:', requestData);
    
    try {
        const response = await fetch('/api/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            displayResults(result);
            saveValues(); // Save successful values
            // Refresh file list after a short delay to ensure file is saved
            setTimeout(() => loadGeneratedFiles(), 500);
        } else {
            displayError(result);
        }
    } catch (error) {
        console.error('Error:', error);
        if (resultsDiv) {
            resultsDiv.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h3>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h3>
                    <p>${error.message}</p>
                    <button onclick="calculateCost()" class="retry-btn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                </div>
            `;
        }
    } finally {
        // Re-enable button
        if (calculateBtn) {
            calculateBtn.disabled = false;
            calculateBtn.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å';
        }
    }
}

// Display results
function displayResults(result) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    // Translate component names
    const componentNames = {
        'materials': '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',
        'processing': '–û–±—Ä–∞–±–æ—Ç–∫–∞',
        'hardware': '–ö—Ä–µ–ø–µ–∂ –∏ —Ñ—É—Ä–Ω–∏—Ç—É—Ä–∞',
        'other': '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
        'spare_parts': '–ó–∞–ø–∞—Å–Ω—ã–µ —á–∞—Å—Ç–∏',
        'logistics': '–õ–æ–≥–∏—Å—Ç–∏–∫–∞',
        'labor': '–†–∞–±–æ—Ç–∞'
    };
    
    // Animate the result
    resultsDiv.style.opacity = '0';
    resultsDiv.innerHTML = `
        <div class="success-result">
            <div class="success-header">
                <div class="success-icon">‚úÖ</div>
                <h3>–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</h3>
            </div>
            
            <div class="total-cost-card">
                <div class="total-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                <div class="total-amount">${formatCurrency(result.results.total_cost)}</div>
            </div>
            
            <div class="components-breakdown">
                <h4>–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º</h4>
                <div class="component-list">
                    ${Object.entries(result.results.component_costs || {}).map(([key, value]) => `
                        <div class="component-item">
                            <span class="component-name">${componentNames[key] || key}</span>
                            <span class="component-value">${formatCurrency(value)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${result.downloadUrl ? `
                <div class="download-section">
                    <a href="${result.downloadUrl}" class="download-btn" download>
                        üì• –°–∫–∞—á–∞—Ç—å Excel —Ñ–∞–π–ª
                    </a>
                </div>
            ` : ''}
            
            <div class="result-footer">
                <div class="meta-info">
                    <div>ID –∑–∞–ø—Ä–æ—Å–∞: <code>${result.request_id}</code></div>
                    <div>–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: <strong>${result.processing_time_ms}–º—Å</strong></div>
                    ${result.metadata ? `<div>–í–µ—Ä—Å–∏—è: ${result.metadata.excelVersion}</div>` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Fade in animation
    setTimeout(() => {
        resultsDiv.style.opacity = '1';
        resultsDiv.style.transition = 'opacity 0.3s ease-in';
    }, 100);
}

// Display error
function displayError(error) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    let errorDetails = '';
    
    if (error.error && error.error.details) {
        const details = error.error.details;
        
        if (details.field_errors) {
            errorDetails += '<div class="error-section"><h4>üîç –û—à–∏–±–∫–∏ –≤ –ø–æ–ª—è—Ö:</h4><div class="error-list">';
            for (const [field, message] of Object.entries(details.field_errors)) {
                // Find field label
                let fieldLabel = field;
                Object.values(FIELD_SECTIONS).forEach(section => {
                    const fieldDef = section.fields.find(f => f.id === field);
                    if (fieldDef) {
                        fieldLabel = fieldDef.label;
                    }
                });
                
                errorDetails += `
                    <div class="error-item">
                        <span class="error-field">${fieldLabel}</span>
                        <span class="error-message">${message}</span>
                    </div>
                `;
                
                // Highlight error field
                const input = document.getElementById(field);
                if (input) {
                    input.classList.add('error');
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            errorDetails += '</div></div>';
        }
        
        if (details.missing_required_fields) {
            errorDetails += '<div class="error-section"><h4>üìã –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã:</h4><div class="missing-fields">';
            details.missing_required_fields.forEach(field => {
                // Find field label
                let fieldLabel = field;
                Object.values(FIELD_SECTIONS).forEach(section => {
                    const fieldDef = section.fields.find(f => f.id === field);
                    if (fieldDef) {
                        fieldLabel = fieldDef.label;
                    }
                });
                errorDetails += `<div class="missing-field">‚Ä¢ ${fieldLabel}</div>`;
            });
            errorDetails += '</div></div>';
        }
    }
    
    resultsDiv.innerHTML = `
        <div class="error-result">
            <div class="error-header">
                <div class="error-icon">‚ùå</div>
                <h3>–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ</h3>
            </div>
            <div class="error-message-main">
                ${error.error?.message || error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
            </div>
            ${errorDetails}
            <div class="error-actions">
                <button onclick="calculateCost()" class="retry-btn">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç</button>
                <button onclick="clearErrors()" class="clear-errors-btn">–û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏</button>
            </div>
        </div>
    `;
}

// Clear error highlighting
function clearErrors() {
    document.querySelectorAll('input.error, select.error, textarea.error').forEach(input => {
        input.classList.remove('error');
    });
    document.getElementById('results').innerHTML = '';
}

// Format currency
function formatCurrency(value) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB'
    }).format(value);
}

// Load defaults
function loadDefaults() {
    Object.values(FIELD_SECTIONS).forEach(section => {
        section.fields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input && field.default !== undefined) {
                input.value = field.default;
            }
        });
    });
    saveValues();
}

// Clear form
function clearForm() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è?')) {
        Object.values(FIELD_SECTIONS).forEach(section => {
            section.fields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input) {
                    input.value = '';
                    input.classList.remove('error');
                }
            });
        });
        localStorage.removeItem('calculatorValues');
        document.getElementById('results').innerHTML = '';
    }
}

// Save values to localStorage
function saveValues() {
    const values = {};
    Object.values(FIELD_SECTIONS).forEach(section => {
        section.fields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input && input.value) {
                values[field.id] = input.value;
            }
        });
    });
    localStorage.setItem('calculatorValues', JSON.stringify(values));
}

// Load saved values from localStorage
function loadSavedValues() {
    const saved = localStorage.getItem('calculatorValues');
    if (saved) {
        try {
            const values = JSON.parse(saved);
            Object.entries(values).forEach(([fieldId, value]) => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.value = value;
                }
            });
        } catch (error) {
            console.error('Error loading saved values:', error);
        }
    }
}

// Auto-save on input change
document.addEventListener('change', function(e) {
    if (e.target.matches('input, select, textarea')) {
        saveValues();
    }
});

// Load generated files list
async function loadGeneratedFiles() {
    try {
        const response = await fetch('/api/excel-files');
        if (response.ok) {
            const data = await response.json();
            updateFileList(data.files || []);
        }
    } catch (error) {
        console.error('Error loading files:', error);
        updateFileList([]);
    }
}

// Update file list display
function updateFileList(files) {
    const fileList = document.getElementById('fileList');
    if (!fileList) return;
    
    if (!files || files.length === 0) {
        fileList.innerHTML = '<div style="padding:20px;text-align:center;color:#718096;">–§–∞–π–ª—ã –µ—â–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã</div>';
        return;
    }
    
    fileList.innerHTML = files.slice(0, 10).map(file => `
        <div class="file-item">
            <div class="file-info">
                <div class="file-name" title="${file.name}">${file.name}</div>
                <div class="file-meta">${new Date(file.created).toLocaleString('ru-RU')} ‚Ä¢ ${formatFileSize(file.size)}</div>
            </div>
            <div class="file-actions">
                <a href="${file.downloadUrl}" class="download-btn" download>–°–∫–∞—á–∞—Ç—å</a>
            </div>
        </div>
    `).join('');
}

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

// Upload functionality
function showUploadDialog() {
    document.getElementById('excelFileInput').click();
}

async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.xlsx')) {
        showErrorModal('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx)');
        event.target.value = '';
        return;
    }
    
    // Validate file size
    if (file.size > 10 * 1024 * 1024) {
        showErrorModal('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10 –ú–ë');
        event.target.value = '';
        return;
    }
    
    // Show upload status
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = `
        <div class="upload-progress">
            <div class="spinner"></div>
            <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: ${file.name}...</span>
        </div>
    `;
    
    // Upload file
    const formData = new FormData();
    formData.append('excel', file);
    
    try {
        const response = await fetch('/api/upload-prefill', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Populate fields
            const populationResult = populateFields(result.extracted_fields);
            
            // Show success modal
            showSuccessModal(populationResult, result);
            
            // Clear file input
            event.target.value = '';
            
            // Hide status
            statusDiv.style.display = 'none';
        } else {
            showErrorModal('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª');
            statusDiv.style.display = 'none';
        }
    } catch (error) {
        console.error('Upload error:', error);
        showErrorModal('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        statusDiv.style.display = 'none';
    }
}

function populateFields(extractedFields) {
    let populatedCount = 0;
    let skippedCount = 0;
    const skippedDetails = [];
    
    for (const [fieldId, value] of Object.entries(extractedFields)) {
        const element = document.getElementById(fieldId);
        if (element) {
            // Set value based on element type
            if (element.tagName === 'SELECT') {
                let processedValue = String(value);
                
                // Special handling for pressure fields (add –†—É prefix if missing)
                if (fieldId.includes('Pressure') && !processedValue.startsWith('–†—É')) {
                    processedValue = '–†—É' + processedValue;
                }
                
                // Special handling for diameter fields (add –î—É prefix if missing)
                if (fieldId.includes('Diameter') && !processedValue.startsWith('–î—É')) {
                    processedValue = '–î—É' + processedValue;
                }
                
                // Check if processed value exists first
                let optionExists = Array.from(element.options).some(opt => opt.value === processedValue);
                
                if (optionExists) {
                    element.value = processedValue;
                    populatedCount++;
                } else {
                    // Try original value if processed doesn't work
                    optionExists = Array.from(element.options).some(opt => opt.value === String(value));
                    if (optionExists) {
                        element.value = value;
                        populatedCount++;
                    } else {
                        // Get available options for better error message
                        const availableOptions = Array.from(element.options)
                            .filter(opt => opt.value)
                            .map(opt => opt.value)
                            .slice(0, 5) // Show first 5 options
                            .join(', ');
                        
                        skippedDetails.push({
                            field: fieldId,
                            value: value,
                            reason: `–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø–∏—Å–∫–µ. –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏: ${availableOptions}...`
                        });
                        skippedCount++;
                    }
                }
            } else {
                element.value = value;
                populatedCount++;
            }
            
            // Remove any error styling
            element.classList.remove('error');
        } else {
            // Try to find field label for better error message
            let fieldLabel = fieldId;
            Object.values(FIELD_SECTIONS).forEach(section => {
                const fieldDef = section.fields.find(f => f.id === fieldId);
                if (fieldDef) {
                    fieldLabel = fieldDef.label;
                }
            });
            
            skippedDetails.push({
                field: fieldId,
                value: value,
                reason: '–ü–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ñ–æ—Ä–º—ã'
            });
            skippedCount++;
        }
    }
    
    // Save values to localStorage
    saveValues();
    
    return {
        populatedCount,
        skippedCount,
        totalFields: Object.keys(extractedFields).length,
        skippedDetails
    };
}

function showSuccessModal(populationResult, uploadResult) {
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.id = 'uploadSuccessModal';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content upload-success-modal';
    
    modalContent.innerHTML = `
        <div class="modal-header success">
            <h2>‚úÖ Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!</h2>
        </div>
        <div class="modal-body">
            <div class="upload-stats">
                <div class="stat-item success">
                    <span class="stat-value">${populationResult.populatedCount}</span>
                    <span class="stat-label">–ø–æ–ª–µ–π –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${populationResult.totalFields}</span>
                    <span class="stat-label">–≤—Å–µ–≥–æ –ø–æ–ª–µ–π –≤ —Ñ–∞–π–ª–µ</span>
                </div>
                ${populationResult.skippedCount > 0 ? `
                    <div class="stat-item warning">
                        <span class="stat-value">${populationResult.skippedCount}</span>
                        <span class="stat-label">–ø–æ–ª–µ–π –ø—Ä–æ–ø—É—â–µ–Ω–æ</span>
                    </div>
                ` : ''}
            </div>
            
            ${populationResult.skippedDetails && populationResult.skippedDetails.length > 0 ? `
                <div class="upload-warnings">
                    <h4>‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–æ–ª—è (${populationResult.skippedDetails.length}):</h4>
                    <div class="skipped-fields-list">
                        ${populationResult.skippedDetails.map(item => {
                            // Try to find a better label for the field
                            let fieldLabel = item.field;
                            let fieldLocation = '';
                            
                            // Extract cell location from field ID if possible
                            const match = item.field.match(/([A-Z]\d+)/);
                            if (match) {
                                fieldLocation = ` (—è—á–µ–π–∫–∞ ${match[1]})`;
                            }
                            
                            return `
                            <div class="skipped-field-item">
                                <div class="skip-field-header">
                                    <strong>${item.field}</strong>${fieldLocation}
                                </div>
                                <div class="skip-field-details">
                                    <span class="skip-value">üìù –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ Excel: <code>${item.value}</code></span>
                                    <span class="skip-reason">‚ùå –ü—Ä–∏—á–∏–Ω–∞: ${item.reason}</span>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${uploadResult.warnings && uploadResult.warnings.length > 0 ? `
                <div class="upload-warnings">
                    <h4>‚ö†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h4>
                    <ul>
                        ${uploadResult.warnings.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <p class="modal-message">
                –§–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Excel —Ñ–∞–π–ª–∞.
                –ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å—á–µ—Ç—É" –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –∫–Ω–æ–ø–∫–µ —Ä–∞—Å—á–µ—Ç–∞.
            </p>
        </div>
        <div class="modal-footer">
            <button onclick="closeModalAndScroll()" class="modal-btn primary">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å—á–µ—Ç—É
            </button>
            <button onclick="closeModal('uploadSuccessModal')" class="modal-btn secondary">
                –û—Å—Ç–∞—Ç—å—Å—è –Ω–∞ –º–µ—Å—Ç–µ
            </button>
        </div>
    `;
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
}

function showErrorModal(title, message) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.id = 'uploadErrorModal';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content upload-error-modal';
    
    modalContent.innerHTML = `
        <div class="modal-header error">
            <h2>‚ùå ${title}</h2>
        </div>
        <div class="modal-body">
            <p>${message}</p>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('uploadErrorModal')" class="modal-btn primary">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    `;
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

function closeModalAndScroll() {
    closeModal('uploadSuccessModal');
    
    // Scroll to calculate button
    const calculateBtn = document.getElementById('calculateBtn');
    if (calculateBtn) {
        calculateBtn.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Add highlight animation
        calculateBtn.classList.add('highlight-animation');
        setTimeout(() => {
            calculateBtn.classList.remove('highlight-animation');
        }, 2000);
    }
}

// Add styles for sections
const style = document.createElement('style');
style.textContent = `
    /* Upload Section Styles - Reduced spacing */
    .upload-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    .upload-container {
        background: white;
        border-radius: 6px;
        padding: 15px;
        text-align: center;
    }
    
    .upload-container h2 {
        margin: 0 0 5px 0;
        color: #2c3e50;
        font-size: 20px;
    }
    
    .upload-container p {
        color: #666;
        margin: 0 0 10px 0;
        font-size: 13px;
    }
    
    .upload-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .upload-excel-btn {
        background: linear-gradient(135deg, #00c853 0%, #43a047 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,200,83,0.3);
    }
    
    .upload-excel-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,200,83,0.4);
    }
    
    .upload-icon {
        font-size: 20px;
    }
    
    .sample-link {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: color 0.3s;
    }
    
    .sample-link:hover {
        color: #764ba2;
        text-decoration: underline;
    }
    
    .upload-status {
        margin-top: 20px;
    }
    
    .upload-progress {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 15px;
        background: #f0f4ff;
        border-radius: 8px;
        color: #667eea;
        font-weight: 500;
    }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        padding: 15px;
        border-radius: 12px 12px 0 0;
        color: white;
    }
    
    .modal-header.success {
        background: linear-gradient(135deg, #00c853 0%, #43a047 100%);
    }
    
    .modal-header.error {
        background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 18px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .upload-stats {
        display: flex;
        justify-content: space-around;
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        display: block;
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-item.success .stat-value {
        color: #00c853;
    }
    
    .stat-item.warning .stat-value {
        color: #ff9800;
    }
    
    .stat-label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    .upload-warnings {
        background: #fff5f5;
        border-left: 3px solid #ff9800;
        padding: 10px;
        border-radius: 4px;
        margin: 8px 0;
    }
    
    .upload-warnings h4 {
        margin: 0 0 8px 0;
        color: #e65100;
        font-size: 13px;
    }
    
    .upload-warnings ul {
        margin: 0;
        padding-left: 15px;
        font-size: 12px;
        color: #666;
    }
    
    .skipped-fields-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .skipped-field-item {
        background: white;
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        border: 1px solid #ffecb3;
    }
    
    .skip-field-header {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 4px;
    }
    
    .skip-field-header strong {
        color: #e65100;
        font-size: 13px;
        font-family: monospace;
    }
    
    .skip-field-details {
        display: flex;
        flex-direction: column;
        gap: 3px;
        padding-left: 10px;
    }
    
    .skip-value {
        color: #333;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .skip-value code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        color: #d73a49;
    }
    
    .skip-reason {
        color: #666;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .modal-message {
        text-align: center;
        color: #666;
        margin: 20px 0;
        font-size: 14px;
    }
    
    .modal-footer {
        padding: 15px 20px;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    
    .modal-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .modal-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    }
    
    .modal-btn.secondary {
        background: #e9ecef;
        color: #495057;
    }
    
    .modal-btn.secondary:hover {
        background: #dee2e6;
    }
    
    /* Highlight animation for calculate button */
    .highlight-animation {
        animation: highlight 2s ease;
    }
    
    @keyframes highlight {
        0%, 100% {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        50% {
            box-shadow: 0 0 30px rgba(102,126,234,0.8);
            transform: scale(1.05);
        }
    }
    
    .section {
        margin-bottom: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
    }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px;
        margin: 0;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }
    
    .section-header:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    
    .section-toggle {
        font-size: 12px;
        width: 20px;
    }
    
    .field-count {
        margin-left: auto;
        font-size: 14px;
        opacity: 0.9;
    }
    
    .section-content {
        padding: 12px;
        background: white;
    }
    
    .fields-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 10px;
    }
    
    .section-navigation {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
    }
    
    .section-navigation button {
        padding: 6px 12px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }
    
    .section-navigation button:hover {
        background: #45a049;
    }
    
    .currency-symbol, .percentage-symbol {
        color: #4CAF50;
        font-weight: bold;
    }
    
    input.error {
        border-color: #f44336;
        background-color: #ffebee;
    }
    
    .total-cost {
        font-size: 24px;
        color: #4CAF50;
        font-weight: bold;
    }
    
    /* Loading state styles */
    .loading-state {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 20px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Success result styles */
    .success-result {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .success-header {
        background: linear-gradient(135deg, #00c853 0%, #43a047 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .success-icon {
        font-size: 24px;
    }
    
    .success-header h3 {
        margin: 0;
        font-size: 18px;
    }
    
    .total-cost-card {
        background: linear-gradient(135deg, #f0f4ff 0%, #e8efff 100%);
        margin: 15px;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .total-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    
    .total-amount {
        font-size: 28px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .components-breakdown {
        padding: 15px;
    }
    
    .components-breakdown h4 {
        margin: 0 0 12px 0;
        color: #2c3e50;
        font-size: 14px;
    }
    
    .component-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .component-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 10px;
        background: #f8f9fa;
        border-radius: 6px;
        transition: background 0.2s;
        font-size: 13px;
    }
    
    .component-item:hover {
        background: #e9ecef;
    }
    
    .component-name {
        color: #495057;
        font-weight: 500;
        font-size: 13px;
    }
    
    .component-value {
        color: #28a745;
        font-weight: bold;
        font-size: 13px;
    }
    
    .download-section {
        padding: 0 20px 20px;
        text-align: center;
    }
    
    .download-btn {
        display: inline-block;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: bold;
        transition: transform 0.2s;
    }
    
    .download-btn:hover {
        transform: translateY(-2px);
    }
    
    .result-footer {
        background: #f8f9fa;
        padding: 15px 20px;
        border-top: 1px solid #dee2e6;
    }
    
    .meta-info {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #6c757d;
    }
    
    .meta-info code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
    }
    
    /* Error state styles */
    .error-result {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .error-header {
        background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .error-icon {
        font-size: 24px;
    }
    
    .error-header h3 {
        margin: 0;
        font-size: 18px;
    }
    
    .error-message-main {
        padding: 15px;
        font-size: 14px;
        color: #721c24;
        background: #f8d7da;
        border-left: 4px solid #f44336;
        margin: 15px;
        border-radius: 4px;
    }
    
    .error-section {
        padding: 0 15px 15px;
    }
    
    .error-section h4 {
        color: #721c24;
        margin: 12px 0;
        font-size: 14px;
    }
    
    .error-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .error-item {
        display: flex;
        flex-direction: column;
        padding: 10px;
        background: #fff5f5;
        border-left: 3px solid #f44336;
        border-radius: 4px;
    }
    
    .error-field {
        font-weight: bold;
        color: #721c24;
        margin-bottom: 4px;
        font-size: 13px;
    }
    
    .error-message {
        color: #666;
        font-size: 12px;
    }
    
    .missing-fields {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .missing-field {
        padding: 6px 10px;
        background: #fff5f5;
        border-radius: 4px;
        color: #721c24;
        font-size: 13px;
    }
    
    .error-actions {
        padding: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .retry-btn, .clear-errors-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .retry-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .clear-errors-btn {
        background: #6c757d;
        color: white;
    }
    
    .retry-btn:hover, .clear-errors-btn:hover {
        transform: translateY(-2px);
    }
    
    /* Error state for connection */
    .error-state {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .error-state .error-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }
`;
document.head.appendChild(style);