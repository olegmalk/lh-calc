openapi: 3.0.3
info:
  title: LH Calculator Excel API
  version: 2.1.0
  description: |
    Excel-based calculation service with 141 fields for engineering and supply chain calculations.
    
    ## Field Type Validation
    The API automatically detects and validates field types:
    - **Currency**: Price fields (e.g., sup_D8_flowPartMaterialPricePerKg) - min: 0, max 2 decimal places
    - **Number**: Quantity/measurement fields - must be valid numbers, min: 0
    - **Percentage**: Coefficient fields (e.g., sup_D17_panelCuttingCoefficient) - range: 0-100
    - **Text**: String fields with max length validation
    - **Textarea**: Long text fields for descriptions
    - **Enum**: Dropdown fields with values from Excel template (31 fields total)
    
    ## Validation Rules
    - Non-numeric values in number fields are rejected (e.g., "abc", "1,000", "$100")
    - Negative values rejected for fields with min: 0
    - Currency fields allow maximum 2 decimal places
    - Enum fields must match exact values from Excel template
    - Empty/null values are allowed for optional fields

servers:
  - url: http://localhost:3000
    description: Development server

paths:
  /api/calculate:
    post:
      summary: Process calculation request
      description: Processes 141 fields through Excel formulas and returns calculated values
      operationId: calculateValues
      tags:
        - Calculations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculationRequest'
            examples:
              minimal:
                summary: Minimal valid request
                value:
                  tech_D27_sequenceNumber: 100
                  tech_E27_customerOrderPosition: "E-113"
                  tech_F27_deliveryType: "Целый ТА"
                  tech_G27_sizeTypeK4: "К4-750"
                  tech_H27_passes: "1/6"
                  tech_I27_plateQuantity: 5
                  tech_J27_calcPressureHotSide: 10
                  tech_K27_calcPressureColdSide: 1
                  tech_L27_calcTempHotSide: 2
                  tech_M27_calcTempColdSide: 250
                  tech_P27_plateMaterial: "AISI 316L"
                  tech_R27_bodyMaterial: "12Х18Н10Т"
                  tech_S27_plateSurfaceType: "гофра"
                  tech_T27_drawDepth: 20
                  tech_U27_plateThickness: 1.2
                  tech_V27_claddingThickness: 1.5
                  sup_F2_projectNumber: "PROJ-2024-001"
                  sup_D8_flowPartMaterialPricePerKg: 50000
                  sup_E8_flowPartMaterialPrice: 55000
                  sup_K13_normHoursPerUnit: 10
                  sup_P13_internalLogistics: 100000
                  sup_D78_stainlessSteelThickness: 25
                  sup_D43_studM24x2000Price: 1000
                  sup_D44_studM24x1000Price: 2000
                  sup_D45_studM20x2000Price: 3000
                  sup_D46_studM20M16x1000Price: 4000
      responses:
        '200':
          description: Successful calculation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationResponse'
        '422':
          description: Validation or processing error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      summary: Health check
      tags:
        - Monitoring
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  timestamp:
                    type: string
                    format: date-time

  /api/metrics:
    get:
      summary: System metrics
      tags:
        - Monitoring
      responses:
        '200':
          description: Current metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  memory:
                    type: object
                    properties:
                      heapUsed:
                        type: number
                      heapTotal:
                        type: number
                      rss:
                        type: number
                  queue:
                    type: object
                    properties:
                      size:
                        type: integer
                      pending:
                        type: integer
                      processing:
                        type: integer
                  workers:
                    type: object
                    properties:
                      total:
                        type: integer
                      busy:
                        type: integer
                      available:
                        type: integer

  /api/fields/required:
    get:
      summary: Get required fields list
      tags:
        - Metadata
      responses:
        '200':
          description: List of required field names
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  fields:
                    type: array
                    items:
                      type: string
                  count:
                    type: integer

  /api/fields/enum:
    get:
      summary: Get enum fields with allowed values
      description: Returns all fields that have enum validation with their allowed values from Excel template
      tags:
        - Metadata
      responses:
        '200':
          description: Enum fields with their allowed values
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                    description: Number of enum fields
                  fields:
                    type: object
                    additionalProperties:
                      type: array
                      items:
                        type: string
                    example:
                      tech_P27_plateMaterial: ["AISI 316L", "SMO 254", "Hast-C276", "Titanium"]
                      tech_R27_bodyMaterial: ["ст3", "ст20", "09Г2С", "12Х18Н10Т"]
                  message:
                    type: string

  /api/fields/metadata:
    get:
      summary: Get field metadata with types and validation rules
      description: Returns comprehensive metadata for all fields including detected types, validation rules, and enum values
      tags:
        - Metadata
      responses:
        '200':
          description: Field metadata with type information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                    description: Total number of fields
                  fields:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          description: Field identifier
                        type:
                          type: string
                          enum: [text, number, enum, date, email, url, percentage, currency, textarea, boolean]
                          description: Detected field type
                        confidence:
                          type: number
                          format: float
                          minimum: 0
                          maximum: 1
                          description: Confidence score for type detection
                        validation:
                          type: object
                          properties:
                            min:
                              type: number
                              description: Minimum value for numeric types
                            max:
                              type: number
                              description: Maximum value for numeric types
                            pattern:
                              type: string
                              description: Regex pattern for validation
                            maxLength:
                              type: integer
                              description: Maximum length for text fields
                            required:
                              type: boolean
                              description: Whether field is required
                            decimalPlaces:
                              type: integer
                              description: Maximum decimal places for currency
                        enumValues:
                          type: array
                          items:
                            type: string
                          description: Allowed values for enum type fields
                  message:
                    type: string

  /api/openapi.yaml:
    get:
      summary: Get OpenAPI specification
      tags:
        - Metadata
      responses:
        '200':
          description: OpenAPI specification in YAML format
          content:
            text/yaml:
              schema:
                type: string


components:
  schemas:
    CalculationRequest:
      type: object
      required:
        # Engineering fields (технолог sheet) - Required
        - tech_D27_sequenceNumber
        - tech_E27_customerOrderPosition
        - tech_F27_deliveryType
        - tech_G27_sizeTypeK4
        - tech_H27_passes
        - tech_I27_plateQuantity
        - tech_J27_calcPressureHotSide
        - tech_K27_calcPressureColdSide
        - tech_L27_calcTempHotSide
        - tech_M27_calcTempColdSide
        - tech_P27_plateMaterial
        - tech_R27_bodyMaterial
        - tech_S27_plateSurfaceType
        - tech_T27_drawDepth
        - tech_U27_plateThickness
        - tech_V27_claddingThickness
        # Supply fields (снабжение sheet) - Required
        - sup_F2_projectNumber
        - sup_D8_flowPartMaterialPricePerKg
        - sup_E8_flowPartMaterialPrice
        - sup_K13_normHoursPerUnit
        - sup_P13_internalLogistics
        - sup_D78_stainlessSteelThickness
        - sup_D43_studM24x2000Price
        - sup_D44_studM24x1000Price
        - sup_D45_studM20x2000Price
        - sup_D46_studM20M16x1000Price
      properties:
        # Engineering fields (технолог sheet)
        tech_D27_sequenceNumber:
          type: number
          minimum: 0
          description: Equipment type identifier
        tech_E27_customerOrderPosition:
          type: string
          pattern: '^[ЕК][-0-9А-Я*]*$'
          description: Equipment code (e.g., "Е-113", "К4-750")
        tech_F27_deliveryType:
          type: string
          enum: ['Целый ТА', 'ШОТ-БЛОК', 'РЕИНЖ']
          description: Delivery type
        tech_G27_sizeTypeK4:
          type: string
          description: Equipment size specification
        tech_H27_passes:
          type: string
          pattern: '^\d+\/\d+$'
          description: Fraction specification (e.g., "1/6")
        tech_I27_plateQuantity:
          type: number
          minimum: 0
        tech_J27_calcPressureHotSide:
          type: number
          minimum: 0
        tech_K27_calcPressureColdSide:
          type: number
          minimum: 0
        tech_L27_calcTempHotSide:
          type: number
          minimum: 0
        tech_M27_calcTempColdSide:
          type: number
          minimum: 0
          description: Material temperature rating
        tech_N27_pressureTestHot:
          type: number
          description: Hot pressure test value (computed)
        tech_O27_pressureTestCold:
          type: number
          description: Cold pressure test value (computed)
        tech_P27_plateMaterial:
          type: string
          enum: ['AISI 316L', 'SMO 254', 'Hast-C276', 'Titanium', 'AISI 304', 'AISI316Ti', '904L']
          description: Primary material type
        tech_Q27_materialType:
          type: string
          description: Secondary material type (computed from P27)
        tech_R27_bodyMaterial:
          type: string
          enum: ['ст3', 'ст20', '09Г2С', '12Х18Н10Т', 'AISI 304', 'AISI 316L', 'AISI 321', 'AISI 316Ti']
          description: Material thickness type
        tech_S27_plateSurfaceType:
          type: string
          enum: ['гофра', 'дв. лунка', 'од. лунка', 'шпилька', 'шпилька-лунка']
          description: Surface pattern type
        tech_T27_drawDepth:
          type: number
          minimum: 0
        tech_U27_plateThickness:
          type: number
          enum: [0.8, 1, 1.2, 1.5, 2, 3, 5]
          description: Material thickness in mm
        tech_V27_claddingThickness:
          type: number
          enum: [0.8, 1, 1.2, 1.5, 2, 3, 5]
          description: Additional thickness specification

        # Project identification
        sup_F2_projectNumber:
          type: string
          description: Project number/identifier
          example: "PROJ-2024-001"
        sup_D9_bodyMaterial:
          type: string
          enum: ['ст3', 'ст20', '09Г2С', '12Х18Н10Т', 'AISI 304', 'AISI 316L', 'AISI 321', 'AISI 316Ti']
          description: Price material specification

        # Supply fields - Required prices (Currency type - max 2 decimal places)
        sup_D8_flowPartMaterialPricePerKg:
          type: number
          format: float
          minimum: 0
          maximum: 1000000
          description: Price per kg - Currency field with max 2 decimal places
        sup_E8_flowPartMaterialPrice:
          type: number
          minimum: 0
          maximum: 1000000
          description: Alternative material price
        sup_K13_normHoursPerUnit:
          type: number
          minimum: 0
          maximum: 10000
          description: Total normalized quantity cost
        sup_P13_internalLogistics:
          type: number
          minimum: 0
          maximum: 10000000
          description: Normalized material quantity cost
        sup_D78_stainlessSteelThickness:
          type: number
          minimum: 0
          maximum: 100
          description: Mass thickness parameter

        # Supply fields - Component costs
        sup_D43_studM24x2000Price:
          type: number
          minimum: 0
        sup_D44_studM24x1000Price:
          type: number
          minimum: 0
        sup_D45_studM20x2000Price:
          type: number
          minimum: 0
        sup_D46_studM20M16x1000Price:
          type: number
          minimum: 0

        # Additional required numeric fields
        sup_G43_nutM24DIN6330Price:
          type: number
          minimum: 0
        sup_G44_nutM24DIN933Price:
          type: number
          minimum: 0
        sup_G45_nutM20M16DIN933Price:
          type: number
          minimum: 0
        sup_H54_spareFlangeFlange1Price:
          type: number
          minimum: 0
        sup_H55_spareFlangeFlange2Price:
          type: number
          minimum: 0
        sup_H56_spareFlangeFlange3Price:
          type: number
          minimum: 0
        sup_H57_spareFlangeFlange4Price:
          type: number
          minimum: 0
        sup_I38_eyeboltKitMaterialCost:
          type: number
          minimum: 0
        sup_I39_eyeboltKitProcessingCost:
          type: number
          minimum: 0
        sup_I50_sparePanelStudQuantity:
          type: number
          minimum: 0
        sup_I51_sparePanelNutQuantity:
          type: number
          minimum: 0
        sup_I52_sparePanelWasherQuantity:
          type: number
          minimum: 0
        sup_I54_flangeFastenersFlange1Quantity:
          type: number
          minimum: 0
        sup_I55_flangeFastenersFlange2Quantity:
          type: number
          minimum: 0
        sup_I56_flangeFastenersFlange3Quantity:
          type: number
          minimum: 0
        sup_I57_flangeFastenersFlange4Quantity:
          type: number
          minimum: 0
        sup_K38_supportsKitMaterialCost:
          type: number
          minimum: 0
        sup_K39_supportsKitProcessingCost:
          type: number
          minimum: 0
        sup_M38_bracesKitMaterialCost:
          type: number
          minimum: 0
        sup_M39_bracesKitProcessingCost:
          type: number
          minimum: 0
        sup_M44_otherMaterialsCost1:
          type: number
          minimum: 0
        sup_M45_otherMaterialsCost2:
          type: number
          minimum: 0
        sup_M46_otherMaterialsCost3:
          type: number
          minimum: 0
        sup_M51_spareAnchorBoltsCost:
          type: number
          minimum: 0
        sup_M52_spareOtherCost:
          type: number
          minimum: 0
        sup_N50_sparePanelGasketsQuantity:
          type: number
          minimum: 0
        sup_N51_spareAnchorBoltsQuantity:
          type: number
          minimum: 0
        sup_N52_spareOtherQuantity:
          type: number
          minimum: 0
        sup_N54_spareFlangeGasketsFlange1Quantity:
          type: number
          minimum: 0
        sup_N55_spareFlangeGasketsFlange2Quantity:
          type: number
          minimum: 0
        sup_N56_spareFlangeGasketsFlange3Quantity:
          type: number
          minimum: 0
        sup_N57_spareFlangeGasketsFlange4Quantity:
          type: number
          minimum: 0
        sup_P45_unaccountedCost:
          type: number
          minimum: 0
        sup_F39_spareKitsPressureReserve:
          type: number
          minimum: 0

        # Optional fields - Pressure ratings
        sup_C28_panelAFlange1Pressure:
          type: string
          enum: ['Ру6', 'Ру10', 'Ру16', 'Ру25', 'Ру40', 'Ру63', 'Ру100', 'Ру160']
          description: Pressure rating
        sup_C29_panelAFlange2Pressure:
          type: string
          enum: ['Ру6', 'Ру10', 'Ру16', 'Ру25', 'Ру40', 'Ру63', 'Ру100', 'Ру160']
          description: Pipe pressure rating

        # Optional fields - Diameter codes
        sup_D28_panelAFlange1Diameter:
          type: string
          enum: ['Ду25', 'Ду32', 'Ду40', 'Ду50', 'Ду65', 'Ду80', 'Ду100', 'Ду125', 'Ду150', 'Ду200', 'Ду250', 'Ду300', 'Ду350', 'Ду400', 'Ду450', 'Ду600', 'Ду800', 'Ду1000']
          description: Diameter code
        sup_D29_panelAFlange2Diameter:
          type: string
          enum: ['Ду25', 'Ду32', 'Ду40', 'Ду50', 'Ду65', 'Ду80', 'Ду100', 'Ду125', 'Ду150', 'Ду200', 'Ду250', 'Ду300', 'Ду350', 'Ду400', 'Ду450', 'Ду600', 'Ду800', 'Ду1000']
          description: Pipe diameter code

      additionalProperties: true

    CalculationResponse:
      type: object
      required:
        - success
        - results
        - request_id
        - processing_time_ms
      properties:
        success:
          type: boolean
          enum: [true]
        results:
          type: object
          required:
            - calculated_values
            - total_cost
            - component_costs
          properties:
            calculated_values:
              type: object
              properties:
                tech_F27_deliveryType:
                  type: string
                tech_G27_sizeTypeK4:
                  type: string
                tech_P27_plateMaterial:
                  type: string
                tech_Q27_materialType:
                  type: string
                tech_R27_bodyMaterial:
                  type: string
                tech_S27_plateSurfaceType:
                  type: string
                tech_U27_plateThickness:
                  type: number
            total_cost:
              type: number
              description: Total calculated cost
            component_costs:
              type: object
              properties:
                materials:
                  type: number
                processing:
                  type: number
                hardware:
                  type: number
                other:
                  type: number
        request_id:
          type: string
          pattern: '^req_\d{8}T\d{6}_[a-z0-9]{6}$'
        processing_time_ms:
          type: number
        metadata:
          type: object
          additionalProperties: true

    ErrorResponse:
      type: object
      required:
        - success
        - error
        - request_id
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          type: string
          description: Error message
        details:
          type: object
          properties:
            field_errors:
              type: object
              additionalProperties:
                type: string
            missing_required_fields:
              type: array
              items:
                type: string
            excel_errors:
              type: array
              items:
                type: string
            processing_errors:
              type: array
              items:
                type: string
            error_type:
              type: string
              enum: ['VALIDATION_FAILED', 'EXCEL_CALCULATION_FAILED', 'EXCEL_FILE_NOT_FOUND', 'INTERNAL_ERROR', 'INVALID_REQUEST', 'INVALID_INPUT_DATA', 'MISSING_REQUIRED_FIELDS']
            queue_full:
              type: boolean
            retry_after:
              type: string
        request_id:
          type: string

tags:
  - name: Calculations
    description: Main calculation endpoints
  - name: Monitoring
    description: Health and metrics endpoints
  - name: Metadata
    description: API metadata and specifications